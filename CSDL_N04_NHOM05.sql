CREATE DATABASE QUANLYBANMAYTINH;
GO
USE QUANLYBANMAYTINH;

CREATE TABLE THONGSOKYTHUAT
(
  MAMAY NVARCHAR(10) NOT NULL,
  SOKHECAM INT NOT NULL,
  CPU NVARCHAR(40) NOT NULL,
  RAM NVARCHAR(40) NOT NULL,
  OCUNG NVARCHAR(40) NOT NULL,
  MANHINH NVARCHAR(40) NOT NULL,
  VGA NVARCHAR(40) NOT NULL,
  HDH NVARCHAR(40) NOT NULL,
  CONSTRAINT PK_THONGSOKYTHUAT PRIMARY KEY (MAMAY)
);

CREATE TABLE MATHANG
(
  MAHANG NVARCHAR(10) NOT NULL,
  MAMAY NVARCHAR(10) NOT NULL,
  TENHANG NVARCHAR(40) NOT NULL,
  GIANHAP INT ,
  GIABAN INT ,
  SOLUONGTONKHO INT ,
  CONSTRAINT PK_MATHANG PRIMARY KEY (MAHANG),
  CONSTRAINT FK_MATHANG_THONGSOKYTHUAT FOREIGN KEY (MAMAY) REFERENCES THONGSOKYTHUAT(MAMAY)
);

CREATE TABLE KHACHHANG
(
  MAKHACHHANG NVARCHAR(10) NOT NULL,
  TENKHACHHANG NVARCHAR(40)  NOT NULL,
  DIACHIKHACHHANG NVARCHAR(40) ,
  SDTKHACHHANG NVARCHAR(20) ,
  CONSTRAINT PK_KHACHHANG PRIMARY KEY (MAKHACHHANG)
);

CREATE TABLE NHANVIEN
(
  MANHANVIEN NVARCHAR(10) NOT NULL,
  TENNHANVIEN NVARCHAR(40) NOT NULL,
  NGAYSINH DATETIME ,
  GIOITINH NVARCHAR(10) ,
  SDTNHANVIEN NVARCHAR(20) ,
  CALAM NVARCHAR(10) ,
  LUONG INT ,
  CHUCVU NVARCHAR(40) ,
  CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANHANVIEN)
);



CREATE TABLE HOADONNHAP
(
  MAHOADONNHAP NVARCHAR(10) NOT NULL,
  MANHANVIEN NVARCHAR(10) NOT NULL,
  NGAYNHAP DATETIME ,
  TENNHACUNGCAP NVARCHAR(40) NOT NULL,
  CONSTRAINT PK_HOADONNHAP PRIMARY KEY (MAHOADONNHAP),
  CONSTRAINT FK_HOADONNHAP_NHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN)
);

CREATE TABLE HOADONBAN
(
  MAHOADONBAN NVARCHAR(10) NOT NULL,
  MAKHACHHANG NVARCHAR(10) NOT NULL,
  MANHANVIEN NVARCHAR(10) NOT NULL,
  NGAYLAPHOADON DATETIME ,
  CONSTRAINT PK_HOADONBAN PRIMARY KEY (MAHOADONBAN),
  CONSTRAINT FK_HOADONBAN_KHACHHANG FOREIGN KEY (MAKHACHHANG) REFERENCES KHACHHANG(MAKHACHHANG),
  CONSTRAINT FK_HOADONBAN_NHANVIEN FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN(MANHANVIEN)
);

CREATE TABLE BAOHANH
(
  MABAOHANH NVARCHAR(10) NOT NULL,
  MAKHACHHANG NVARCHAR(10) NOT NULL,
  MAHANG NVARCHAR(10) NOT NULL,
  NGAYNHAN DATETIME ,
  NGAYTRA DATETIME ,
  TRANGTHAIBAOHANH NVARCHAR(40) ,
  PHIBAOHANH INT ,
  NOIDUNGBAOHANH NVARCHAR(100) ,
  CONSTRAINT PK_BAOHANH PRIMARY KEY (MABAOHANH),
  CONSTRAINT FK_BAOHANH_KHACHHANG FOREIGN KEY (MAKHACHHANG) REFERENCES KHACHHANG(MAKHACHHANG),
  CONSTRAINT FK_BAOHANH_MATHANG FOREIGN KEY (MAHANG) REFERENCES MATHANG(MAHANG)
);

CREATE TABLE THANHTOAN
(
  MAHANG NVARCHAR(10) NOT NULL,
  MAHOADONBAN NVARCHAR(10) NOT NULL,
  SOLUONG INT ,
  CONSTRAINT PK_THANHTOAN PRIMARY KEY (MAHANG, MAHOADONBAN),
  CONSTRAINT FK_THANHTOAN_MATHANG FOREIGN KEY (MAHANG) REFERENCES MATHANG(MAHANG),
  CONSTRAINT FK_THANHTOAN_HOADONBAN FOREIGN KEY (MAHOADONBAN) REFERENCES HOADONBAN(MAHOADONBAN)
);

CREATE TABLE NGUON
(
  MAHOADONNHAP NVARCHAR(10) NOT NULL,
  MAHANG NVARCHAR(10) NOT NULL,
  SOLUONG INT ,
  CONSTRAINT PK_NGUON PRIMARY KEY (MAHOADONNHAP, MAHANG),
  CONSTRAINT FK_NGUON_HOADONNHAP FOREIGN KEY (MAHOADONNHAP) REFERENCES HOADONNHAP(MAHOADONNHAP),
  CONSTRAINT FK_NGUONMATHANG FOREIGN KEY (MAHANG) REFERENCES MATHANG(MAHANG)
);
INSERT INTO THONGSOKYTHUAT
VALUES (N'X515A',6,N'i5-10100H',N'8GB',N'512GB SSD',N'FULL HD+ 15.6INCH',N'MX450 2GB GDDR5',N' WIN10')
INSERT INTO THONGSOKYTHUAT
VALUES (N'A515B',6,N'I5-10300H',N'16GB',N'256GB SSD',N'FULL HD+ 14INCH',N'INTEL IRIS XE GRAPHICS',N'WIN11')
INSERT INTO THONGSOKYTHUAT
VALUES (N'X413A',8,N'R7-4700U',N'4GB',N'128GB SSD',N'FULL HD 15.6INCH',N'AMD VAGA 7',N'WIN7')
INSERT INTO THONGSOKYTHUAT
VALUES (N'Q521EP',8,N'I7-8700U',N'8GB',N'512GB SSD',N'FULL HD+ 15.6INCH',N'GTX 1650',N'WIN11')
INSERT INTO THONGSOKYTHUAT
VALUES (N'Z1653A',6,N'I7-11800H',N'16GB',N'256GB SSD',N'FULL HD+ 15.6INCH',N'GTX 1650Ti',N'WIN10')
INSERT INTO THONGSOKYTHUAT
VALUES (N'4U6M4PA',4,N'i7-1165G7',N'8GB',N'518GB SSD',N'FULL HD+ 14INCH',N'Intel Iris Xe Graphics',N'WIN10')

INSERT INTO MATHANG 
VALUES(N'8BD923',N'X515A',N'ASUS',10000000,15000000,13)
INSERT INTO MATHANG 
VALUES(N'3QT459',N'A515B',N'ACER',12000000,17000000,24)
INSERT INTO MATHANG 
VALUES(N'7HH634',N'X413A',N'DELL',8000000,13000000,22)
INSERT INTO MATHANG 
VALUES(N'9TH483',N'Q521EP',N'ACER GAMMING',14000000,25000000,17)
INSERT INTO MATHANG 
VALUES(N'5QD964',N'Z1653A',N'ASUS',12000000,20000000,21)
INSERT INTO MATHANG 
VALUES(N'HP456A2',N'4U6M4PA',N'HP',25000000,29000000,8)


INSERT INTO KHACHHANG
VALUES (N'KH001',N'Vũ Hưu Hào',N'Thái Bình',N'0999999233')
INSERT INTO KHACHHANG
VALUES (N'KH002',N'Phạm Văn Thành',N'Bắc Ninh',N'0923454234')
INSERT INTO KHACHHANG
VALUES (N'KH003',N'Nguyễn Hữu Nam',N'Hà Nội',N'0967456653')
INSERT INTO KHACHHANG
VALUES (N'KH004',N'Phạm Quang Đức',N'Hà Nội',N'0364645666')
INSERT INTO KHACHHANG
VALUES (N'KH005',N'Bùi Văn Đạt',N'Hà Nội',N'0958564456')

INSERT INTO NHANVIEN 
VALUES(N'NV01',N'Nguyễn Thế Hướng','2002-04-23',N'Nam' ,N'0934534343',N'8h-13h ',20000000,N'Quản lý ')
INSERT INTO NHANVIEN 
VALUES(N'NV02',N'Nguyễn Ngọc Anh','2004-06-24',N'Nữ ',N'0967888888', N'8h-13h ',7000000,N'Nhân viên')
INSERT INTO NHANVIEN 
VALUES(N'NV03',N'Phạm Quang Nam',' 2001-04-30 ',N'Nam',N'0384239992' ,N'8h-17h ',15000000,N'Nhân viên')
INSERT INTO NHANVIEN 
VALUES(N'NV04',N'Nguyễn Quang Thuần','1999-04-02',N'Nam',N'0946543434',N'8h-17h',10000000,N'Nhân viên')
INSERT INTO NHANVIEN 
VALUES(N'NV05',N'Nguyễn Kim Sa','2002-11-15',N'Nữ ',N'0958566466',N'8h-17h',10000000,N'Nhân viên')

INSERT INTO HOADONBAN 
VALUES (N'MH001',N'KH001',N'NV01','2022-01-19')
INSERT INTO HOADONBAN 
VALUES (N'MH002',N'KH002',N'NV02','2022-02-21')
INSERT INTO HOADONBAN 
VALUES (N'MH003',N'KH003',N'NV03','2022-03-09')
INSERT INTO HOADONBAN 
VALUES (N'MH004',N'KH004',N'NV04','2022-02-02')
INSERT INTO HOADONBAN 
VALUES (N'MH005',N'KH005',N'NV05','2022-03-03')


INSERT INTO HOADONNHAP
VALUES (N'HDN01',N'NV01','2021-01-01',N'Công Ty ASUS')
INSERT INTO HOADONNHAP
VALUES (N'HDN02',N'NV02','2021-03-05',N'Công Ty ACER')
INSERT INTO HOADONNHAP
VALUES (N'HDN03',N'NV03','2021-05-11',N'Công Ty DELL')
INSERT INTO HOADONNHAP
VALUES (N'HDN04',N'NV04','2021-06-12',N'Công Ty ACER')
INSERT INTO HOADONNHAP
VALUES (N'HDN05',N'NV05','2021-09-15',N'Công Ty ASUS')
INSERT INTO HOADONNHAP
VALUES (N'HDN06',N'NV01','2021-07-23',N'Công Ty HP')


INSERT INTO NGUON
VALUES (N'HDN01',N'8BD923',6)
INSERT INTO NGUON
VALUES (N'HDN02',N'3QT459',7)
INSERT INTO NGUON
VALUES (N'HDN03',N'7HH634',8)
INSERT INTO NGUON
VALUES (N'HDN04',N'9TH483',9)
INSERT INTO NGUON
VALUES (N'HDN05',N'5QD964',10)


INSERT INTO BAOHANH 
VALUES(N'BH120',N'KH001',N'8BD923','2022-03-12','2022-03-05', N'Còn bảo hành',30000,N'vệ sinh máy')
INSERT INTO BAOHANH 
VALUES(N'BH003',N'KH002',N'3QT459','2021-12-02','2021-12-12' ,N'hết bảo hành',1000000,N'thay ổ cứng')
INSERT INTO BAOHANH 
VALUES(N'BH078',N'KH001',N'8BD923','2022-02-10','2022-02-17' ,N'Còn bảo hành',50000,N'thay quạt gió')
INSERT INTO BAOHANH 
VALUES(N'BH140',N'KH001',N'8BD923','2022-02-11','2022-02-21' ,N'Còn bảo hành', 700000,N'Thay màn hình')
INSERT INTO BAOHANH 
VALUES(N'BH125',N'KH003', N'7HH634','2022-01-13','2022-01-25',N'Còn bảo hành',1200000,N'Thay bàn phím')



INSERT INTO THANHTOAN
VALUES (N'8BD923',N'MH001',3)
INSERT INTO THANHTOAN
VALUES (N'3QT459',N'MH002',4)
INSERT INTO THANHTOAN
VALUES (N'7HH634',N'MH003',7)
INSERT INTO THANHTOAN
VALUES (N'9TH483',N'MH004',2)
INSERT INTO THANHTOAN
VALUES (N'5QD964',N'MH005',5)


SELECT *
FROM THONGSOKYTHUAT

SELECT *
FROM MATHANG

SELECT *
FROM HOADONNHAP

SELECT *
FROM HOADONBAN

SELECT *
FROM NGUON

SELECT *
FROM NHANVIEN

SELECT *
FROM KHACHHANG

SELECT *
FROM BAOHANH

SELECT *
FROM THANHTOAN

/*1 đưa ra mã hàng , tên hàng , số lượng tồn kho của mặt hang*/
SELECT MAHANG, TENHANG, SOLUONGTONKHO 
FROM MATHANG;

/*2 đưa ra thông tin nhân vien có giới tính là nam */
SELECT *
FROM NHANVIEN
WHERE GIOITINH='nam';

/*3 đưa ra thong tin các mặt hàng có giá bán lớn hơn 15 triệu */
SELECT *
FROM MATHANG 
WHERE GIABAN >=15000000;

/*4 đưa ra thông tin khách hàng có địa chỉ ở Thái Bình */
SELECT *
FROM KHACHHANG
WHERE DIACHIKHACHHANG='Thái Bình';

/*5 đưa ra tất cả tên máy  có ram bằng 8 */
SELECT MAHANG,TENHANG
FROM MATHANG,THONGSOKYTHUAT
WHERE RAM='8GB' AND MATHANG.MAMAY = THONGSOKYTHUAT.MAMAY;

/*6 đưa ra tên khách hàng mua hàng vào ngày 2022-01-19 */
SELECT KHACHHANG.MAKHACHHANG,TENKHACHHANG
FROM KHACHHANG, HOADONBAN
WHERE NGAYLAPHOADON='2022-01-19' AND KHACHHANG.MAKHACHHANG = HOADONBAN.MAKHACHHANG;

/*7 đưa ra tên hàng , SOLUONG được nhập vào ngày 2021-05-11 */
SELECT TENHANG,SOLUONG
FROM MATHANG,HOADONNHAP,NGUON
WHERE HOADONNHAP.NGAYNHAP='2021-05-11' AND NGUON.MAHANG=MATHANG.MAHANG AND NGUON.MAHOADONNHAP=HOADONNHAP.MAHOADONNHAP;

/*8 đưa ra tất cả các máy có ram =8 và màn hình FULL HD+ 15.6 INCH */
SELECT MAHANG,TENHANG
FROM MATHANG, THONGSOKYTHUAT
WHERE RAM='8GB' AND MANHINH='FULL HD+ 15.6INCH' AND MATHANG.MAMAY= THONGSOKYTHUAT.MAMAY;

/*9 đưa ra thông tin khách hàng mua hàng từ ngày 15 tháng 1 năm 2022 đến ngày 15 tháng 2 năm 2022 */
SELECT KHACHHANG.MAKHACHHANG, KHACHHANG.TENKHACHHANG, KHACHHANG.DIACHIKHACHHANG, KHACHHANG.SDTKHACHHANG
FROM KHACHHANG , HOADONBAN
WHERE KHACHHANG.MAKHACHHANG= HOADONBAN.MAKHACHHANG AND NGAYLAPHOADON BETWEEN '2022-01-15' AND '2022-02-15';

/*10 đưa ra thông tin của măt hàng có giá bán cao nhất */
SELECT *
FROM MATHANG 
WHERE GIABAN=(SELECT MAX(GIABAN) FROM MATHANG);

/*11 đưa ra thông tin khách hàng mua hàng gần nhất */
SELECT *
FROM KHACHHANG 
RIGHT JOIN HOADONBAN ON KHACHHANG.MAKHACHHANG = HOADONBAN.MAKHACHHANG
WHERE DATEDIFF(DAY,NGAYLAPHOADON,GETDATE())=(SELECT MIN(DATEDIFF(DAY,NGAYLAPHOADON,GETDATE()))FROM HOADONBAN);

/*12 tinh tổng số tiền bán được trong tháng 3 năm 2022 */

SELECT  SUM(MATHANG.GIABAN*THANHTOAN.SOLUONG) AS DOANHTHUTHANG3
FROM HOADONBAN,MATHANG,THANHTOAN
WHERE MATHANG.MAHANG=THANHTOAN.MAHANG AND HOADONBAN.MAHOADONBAN= THANHTOAN.MAHOADONBAN AND MONTH(HOADONBAN.NGAYLAPHOADON)=3 AND YEAR(HOADONBAN.NGAYLAPHOADON)=2022;

/*13 đưa ra mã khách hàng ,tên khách hàng , mã hàng , tên hàng  bảo hành nhiều nhất  */
SELECT KHACHHANG.MAKHACHHANG , MATHANG.MAHANG ,COUNT(BAOHANH.MAKHACHHANG) AS SOLANBAOHANH 
INTO SOLANKHACHHANGBAOHANH
FROM KHACHHANG,BAOHANH ,MATHANG
WHERE BAOHANH.MAKHACHHANG= KHACHHANG.MAKHACHHANG  AND MATHANG.MAHANG= BAOHANH.MAHANG 
GROUP BY KHACHHANG.MAKHACHHANG,MATHANG.MAHANG;


SELECT KHACHHANG.MAKHACHHANG,KHACHHANG.TENKHACHHANG,MATHANG.MAHANG,MATHANG.TENHANG
FROM MATHANG,KHACHHANG,SOLANKHACHHANGBAOHANH
WHERE KHACHHANG.MAKHACHHANG= SOLANKHACHHANGBAOHANH.MAKHACHHANG AND MATHANG.MAHANG= SOLANKHACHHANGBAOHANH.MAHANG AND  SOLANBAOHANH =(SELECT MAX(SOLANBAOHANH) FROM SOLANKHACHHANGBAOHANH);



/*14 có bao nhiêu sản phẩm khác nhau được bán trong năm 2022 */
SELECT MATHANG.MAHANG,TENHANG
FROM MATHANG,HOADONBAN,THANHTOAN
WHERE YEAR(HOADONBAN.NGAYLAPHOADON)=2022 AND MATHANG.MAHANG= THANHTOAN.MAHANG AND HOADONBAN.MAHOADONBAN= THANHTOAN.MAHOADONBAN;

/*15 tính giá trị trung bình của hóa đơn bán trong năm 2022*/
SELECT AVG(MATHANG.GIABAN*THANHTOAN.SOLUONG) AS GIATRITRUNGBINH
FROM MATHANG,HOADONBAN,THANHTOAN
WHERE YEAR(HOADONBAN.NGAYLAPHOADON)=2022 AND MATHANG.MAHANG= THANHTOAN.MAHANG AND HOADONBAN.MAHOADONBAN= THANHTOAN.MAHOADONBAN;

